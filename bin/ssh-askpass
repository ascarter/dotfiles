#!/bin/sh

case "$1" in
"Confirm user presence"*)
  message="SETDESC $1\nCONFIRM\n"
  CONFIRM=$(printf "$message" | pinentry-mac | tail -n 1 | tr -d '\n')
  # Check if user cancelled (not OK means cancel)
  if [ "$CONFIRM" != "OK" ]; then
    exit 1
  fi
  ;;
*)
  # See if we can get the hash of the key
  # that we want the password for
  # (this enables keychain option support)
  HASHTYPE=$(echo $1 | awk -F':' '{print $1}')
  case "$HASHTYPE" in
  *"SHA256")
    # Grab the actual hash
    SHA256=$(echo $1 | awk -F':' '{print $2}')
    message="SETDESC $1\nOPTION allow-external-password-cache\nSETKEYINFO $SHA256\nGETPIN\n"
    ;;
  *)
    # Otherwise don't include the keyinfo
    message="SETDESC $1\nGETPIN\n"
    ;;
  esac

  # Prompt the user for their pin
  PIN=$(printf "$message" | pinentry-mac | grep D | tr -d '\n')
  # Return the pin to ssh-agent starting after 'D '
  echo "${PIN:2}"
  ;;
esac
